import{_ as a,c as e,o as t,a3 as o}from"./chunks/framework.Cv3JQ2Vj.js";const g=JSON.parse('{"title":"9-10月 bug 复盘","description":"","frontmatter":{"title":"9-10月 bug 复盘","date":"2024-10-26T00:00:00.000Z"},"headers":[],"relativePath":"posts/bug-fu-pan-202409-202410.md","filePath":"posts/bug-fu-pan-202409-202410.md"}'),r={name:"posts/bug-fu-pan-202409-202410.md"},n=o('<h1 id="_9-10月-bug-复盘" tabindex="-1">9-10月 bug 复盘 <a class="header-anchor" href="#_9-10月-bug-复盘" aria-label="Permalink to &quot;9-10月 bug 复盘&quot;">​</a></h1><h2 id="技术支持提报某个商品在-x-号料位有库存-但是无法正常操作移走改库存" tabindex="-1">技术支持提报某个商品在 X 号料位有库存，但是无法正常操作移走改库存 <a class="header-anchor" href="#技术支持提报某个商品在-x-号料位有库存-但是无法正常操作移走改库存" aria-label="Permalink to &quot;技术支持提报某个商品在 X 号料位有库存，但是无法正常操作移走改库存&quot;">​</a></h2><p>原因：数据库当时连接池满了，报错提示为-Timeout: Pool empty. Unable to fetch a connection in 10 seconds, none available[size:5; busy:5; idle:0; lastwait:10000]，这导致一个非常奇葩的中间状态，先简单描述下业务流程：正常业务当数据在审核时，商品的库存会从 A 移动到 B，等到审核通过后会从 B 移动到 C，但是当时用户在审批通过后，我们调用第三方接口异动库存也成功，却不巧在将当前单据的状态改为审批通过并持久化到数据库中这一步挂了，又好巧不巧我们会有一个定时任务每天自动清理当天未及时审批的单据(库存会从 B 还到 A)，于是这笔单据就状态就是审批不通过，但是库存又在 C 里面了，看库存异动日志呢就发现，B -&gt; C 一笔，然后 B - &gt; A 一笔。</p><p>复盘：当时我找了整整一天都没找出来原因，因为日志服务器只保存最新一个月内的日志，而这个是 7 月份发生的事情，我当时也尝试通过钉钉告警消息去找，但是方向错了，我压根没想到根据全局异常的关键字去搜索，而是通过业务的关键词搜索的，最后还是求助领导，然后再领导的思路下，最后根据全局异常的的钉钉告警找到原因了。</p><h2 id="异常处理里有一些货号无法移除-重推也不行" tabindex="-1"><strong>异常处理里有一些货号无法移除 重推也不行</strong> <a class="header-anchor" href="#异常处理里有一些货号无法移除-重推也不行" aria-label="Permalink to &quot;**异常处理里有一些货号无法移除 重推也不行**&quot;">​</a></h2><p>原因：主要有两个，第一个是当时对于称重品记录库存数据时，传递的是数量 1，而不是重量 g，第二个就是订单在销售时，那边传过来的库存单位不一致，那边是好像都是以 kg 为单位，这就导致在对比数量时 0.xx 比 1 小，所以不需要把库存从 A 移动 到 C，但是实际上是需要移动的，不然 C 没有库存就无法处理。</p><p>复盘：库存单位这个锅我不背，因为这个我确实不知道。。。但是当时传递数量而不是重量确实是我当时没有发现这个问题，甚至我在想是不是一开始设计时就出错了，不应该再扩展个重量的字段，而是应该对于标品来说数量就是个数，称重品的数量就是重量，这样的话就不会出现应该传递重量的地方传递成重量了，目前的短接是按 PD 需求暂时停止列印称重品的数据。</p><h2 id="报表显示有一个过期-但是料位上都没有库存" tabindex="-1"><strong>报表显示有一个过期，但是料位上都没有库存</strong> <a class="header-anchor" href="#报表显示有一个过期-但是料位上都没有库存" aria-label="Permalink to &quot;**报表显示有一个过期，但是料位上都没有库存**&quot;">​</a></h2><p>原因：实际上这个问题是正常的，确实是过期了，但是这个问题的提报让我发现了另外一个问题，很多折扣商品被核销了，但是销售状态缺没有变。</p><p>复盘：好像没有改进的地方？没想到什么好方法。</p><h2 id="折扣标作废提示非常品库存有异动请重新确认-使用样品移出提示没非常品" tabindex="-1"><strong>折扣标作废提示非常品库存有异动请重新确认，使用样品移出提示没非常品</strong> <a class="header-anchor" href="#折扣标作废提示非常品库存有异动请重新确认-使用样品移出提示没非常品" aria-label="Permalink to &quot;**折扣标作废提示非常品库存有异动请重新确认，使用样品移出提示没非常品**&quot;">​</a></h2><p>原因：折扣标发起库存异动，第一次库存异动操作接口无响应，又发起了第二次库存异动操作。第二次先扣库存成功，第一次后扣库存成功（无库存从疑似遗失借的库存），第一次操作发起了反向核销（还库存到 C 料位上），导致 C 有+1库存，疑似遗失料位-1库存，导致料位库存不平。</p><p>复盘：和头一个 bug 一样日志没有，但是好在有了经验最后通过全局异常处理发现当时调用第三方接口失败了。</p><h2 id="配置未生效" tabindex="-1"><strong>配置未生效</strong> <a class="header-anchor" href="#配置未生效" aria-label="Permalink to &quot;**配置未生效**&quot;">​</a></h2><p>原因：有个开关没有添加数据，比较扯皮的是这个数据是 PD 在 23 年就要求打开的，结果当时不知道什么情况把这笔数据给漏了，于是乎现在就死无对证，只能吃哑巴亏。 复盘：加个操作日志表</p><h2 id="批量添加时报错乱码" tabindex="-1"><strong>批量添加时报错乱码</strong> <a class="header-anchor" href="#批量添加时报错乱码" aria-label="Permalink to &quot;**批量添加时报错乱码**&quot;">​</a></h2><p>原因：有笔数据操作了数据库最大的存储长度，比较恶心的是虽然是个测试数据，但是没办法关闭，所以最后也只能算我们的 bug</p><p>复盘：也算是没有对这种异常边界情况做相应的过滤。</p><h2 id="折扣商品被核销、但是销售状态显示未销售" tabindex="-1">折扣商品被核销、但是销售状态显示未销售 <a class="header-anchor" href="#折扣商品被核销、但是销售状态显示未销售" aria-label="Permalink to &quot;折扣商品被核销、但是销售状态显示未销售&quot;">​</a></h2><p>原因：折扣商品的价格要大于原价或者活动价，导致被认为不算是“折扣”，所以订单就不会给我们发消息，但是在结算时，又是扫描的折扣商品上面的条码，所以会把这个条码给<strong>核销占用</strong>。</p><p>复盘：这个问题是由另外一个问题发现的，当时梳理了相关逻辑后，确认有两个消息未发送，一个是改变销售状态的消息，一个是扣减库存的消息，后面问了对方才发现了这个问题，问题数据有 1000 多笔，比较麻烦的是，这些库存都遗留在里面了，还不知道后面会不会有人提报问题，算 BUG 了，而且这类问题我都在想要不要加个告警。</p>',21),s=[n];function i(l,h,p,d,c,u){return t(),e("div",null,s)}const _=a(r,[["render",i]]);export{g as __pageData,_ as default};
